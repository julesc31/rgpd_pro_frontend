-- Demo Report Insertion Script
-- This script creates a demo scan with the HTML report template

-- First, ensure we have a demo user (using the demo account email)
DO $$
DECLARE
    demo_user_id UUID;
    demo_scan_id UUID;
BEGIN
    -- Get or create demo user
    SELECT id INTO demo_user_id FROM auth.users WHERE email = 'demo@securescan.com' LIMIT 1;
    
    -- If no demo user exists, we'll use a placeholder UUID
    IF demo_user_id IS NULL THEN
        demo_user_id := '00000000-0000-0000-0000-000000000001'::UUID;
    END IF;

    -- Insert a demo scan
    INSERT INTO scans (
        user_id,
        target_url,
        scan_type,
        status,
        progress,
        started_at,
        completed_at,
        report_html
    ) VALUES (
        demo_user_id,
        'https://www.leboncoin.fr/',
        'full',
        'completed',
        100,
        NOW() - INTERVAL '2 hours',
        NOW() - INTERVAL '1 hour',
        -- Insert the complete HTML report template
        E'<!DOCTYPE html>\n<html lang="fr">\n<head>\n    <meta charset="UTF-8">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>Rapport d\'Audit RGPD - Leboncoin</title>\n    <script src="https://cdn.tailwindcss.com"></script>\n    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>\n    <style>\n        @import url(\'https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap\');\n        * { margin: 0; padding: 0; box-sizing: border-box; }\n        :root {\n            --primary: #1e40af; --primary-light: #3b82f6; --primary-dark: #1e3a8a;\n            --secondary: #64748b; --accent: #8b5cf6; --success: #059669;\n            --warning: #d97706; --danger: #dc2626;\n            --bg-primary: #ffffff; --bg-secondary: #f8fafc; --bg-tertiary: #f1f5f9;\n            --text-primary: #0f172a; --text-secondary: #475569; --text-tertiary: #94a3b8;\n            --border: #e2e8f0; --border-light: #f1f5f9;\n            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);\n            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);\n            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);\n            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);\n        }\n        body {\n            font-family: \'Inter\', -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, sans-serif;\n            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n            background-attachment: fixed;\n            color: var(--text-primary);\n            line-height: 1.6;\n            letter-spacing: -0.011em;\n            -webkit-font-smoothing: antialiased;\n            -moz-osx-font-smoothing: grayscale;\n        }\n        .container { max-width: 1400px; margin: 0 auto; padding: 2.5rem; }\n        .header {\n            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #3b82f6 100%);\n            color: white; padding: 3.5rem 3rem; border-radius: 1.5rem;\n            margin-bottom: 2.5rem; box-shadow: var(--shadow-xl);\n            position: relative; overflow: hidden;\n        }\n        .header::before {\n            content: \'\'; position: absolute; top: 0; right: 0;\n            width: 400px; height: 400px;\n            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);\n            border-radius: 50%; transform: translate(30%, -30%);\n        }\n        .header-content { position: relative; z-index: 1; }\n        .header h1 {\n            font-size: 3rem; font-weight: 800; margin-bottom: 0.75rem;\n            letter-spacing: -0.025em; line-height: 1.1;\n        }\n        .header-subtitle {\n            font-size: 1.5rem; font-weight: 600; opacity: 0.95; margin-bottom: 0.5rem;\n        }\n        .header-meta {\n            font-size: 0.95rem; opacity: 0.8; margin-top: 1.5rem;\n            display: flex; gap: 2rem; flex-wrap: wrap;\n        }\n        .header-meta-item { display: flex; align-items: center; gap: 0.5rem; }\n        .content-wrapper {\n            background: var(--bg-secondary); border-radius: 1.5rem;\n            padding: 2rem; box-shadow: var(--shadow-xl);\n        }\n        .nav-tabs {\n            display: flex; gap: 0.75rem; background: white;\n            padding: 1rem; border-radius: 1rem; margin-bottom: 2rem;\n            box-shadow: var(--shadow); overflow-x: auto;\n            border: 1px solid var(--border-light);\n        }\n        .nav-tab {\n            padding: 0.875rem 1.75rem; border: none; background: transparent;\n            color: var(--text-secondary); cursor: pointer; border-radius: 0.75rem;\n            font-weight: 600; font-size: 0.95rem;\n            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n            white-space: nowrap; position: relative;\n        }\n        .nav-tab:hover {\n            background: var(--bg-secondary); color: var(--text-primary);\n            transform: translateY(-1px);\n        }\n        .nav-tab.active {\n            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);\n            color: white; box-shadow: 0 4px 12px rgba(30, 64, 175, 0.4);\n        }\n        .tab-content { display: none; }\n        .tab-content.active { display: block; animation: fadeInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1); }\n        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }\n        .card {\n            background: white; border-radius: 1rem; padding: 2rem;\n            margin-bottom: 1.5rem; box-shadow: var(--shadow);\n            border: 1px solid var(--border-light); transition: all 0.3s ease;\n        }\n        .card:hover { box-shadow: var(--shadow-lg); transform: translateY(-2px); }\n        .card-header {\n            font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem;\n            color: var(--text-primary); display: flex; align-items: center;\n            gap: 0.75rem; padding-bottom: 1rem;\n            border-bottom: 2px solid var(--border-light); letter-spacing: -0.02em;\n        }\n        .card-header-icon { font-size: 1.75rem; }\n        .badge {\n            display: inline-flex; align-items: center; padding: 0.375rem 1rem;\n            border-radius: 9999px; font-size: 0.875rem; font-weight: 700;\n            letter-spacing: 0.025em; text-transform: uppercase;\n        }\n        .badge-critical {\n            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);\n            color: white; box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);\n        }\n        .badge-high {\n            background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%);\n            color: white; box-shadow: 0 2px 8px rgba(234, 88, 12, 0.3);\n        }\n        .badge-medium {\n            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);\n            color: white; box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);\n        }\n        .badge-low {\n            background: linear-gradient(135deg, #10b981 0%, #059669 100%);\n            color: white; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);\n        }\n        .stat-grid {\n            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));\n            gap: 1.5rem; margin-bottom: 2rem;\n        }\n        .stat-card {\n            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);\n            color: white; padding: 2rem; border-radius: 1rem;\n            box-shadow: var(--shadow-lg); position: relative; overflow: hidden;\n            transition: all 0.3s ease;\n        }\n        .stat-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-xl); }\n        .stat-card::before {\n            content: \'\'; position: absolute; top: 0; right: 0;\n            width: 150px; height: 150px;\n            background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);\n            border-radius: 50%; transform: translate(30%, -30%);\n        }\n        .stat-card-content { position: relative; z-index: 1; }\n        .stat-label {\n            font-size: 0.875rem; font-weight: 600; opacity: 0.9;\n            margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;\n        }\n        .stat-value { font-size: 2.5rem; font-weight: 800; line-height: 1; letter-spacing: -0.025em; }\n        .stat-icon { font-size: 2rem; opacity: 0.2; position: absolute; bottom: 1rem; right: 1rem; }\n        table { width: 100%; border-collapse: separate; border-spacing: 0; }\n        th, td { padding: 1.25rem 1.5rem; text-align: left; border-bottom: 1px solid var(--border-light); }\n        th {\n            background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);\n            font-weight: 700; color: var(--text-primary); font-size: 0.875rem;\n            text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 2px solid var(--border);\n        }\n        thead tr th:first-child { border-top-left-radius: 0.75rem; }\n        thead tr th:last-child { border-top-right-radius: 0.75rem; }\n        tbody tr { transition: all 0.2s ease; }\n        tbody tr:hover { background: var(--bg-secondary); transform: scale(1.01); }\n        tbody tr:last-child td { border-bottom: none; }\n        tbody tr:last-child td:first-child { border-bottom-left-radius: 0.75rem; }\n        tbody tr:last-child td:last-child { border-bottom-right-radius: 0.75rem; }\n        .chart-container {\n            position: relative; height: 350px; margin: 1.5rem 0;\n            padding: 1rem; background: var(--bg-secondary); border-radius: 0.75rem;\n        }\n        .violation-card {\n            background: white; border-radius: 0.75rem; padding: 1.5rem;\n            margin-bottom: 1rem; border-left: 4px solid var(--danger);\n            box-shadow: var(--shadow); transition: all 0.3s ease;\n        }\n        .violation-card:hover { box-shadow: var(--shadow-lg); transform: translateX(4px); }\n        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }\n        .info-item { background: var(--bg-secondary); padding: 1.5rem; border-radius: 0.75rem; border: 1px solid var(--border-light); }\n        .info-label {\n            font-size: 0.875rem; font-weight: 600; color: var(--text-secondary);\n            margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em;\n        }\n        .info-value { font-size: 1.25rem; font-weight: 700; color: var(--text-primary); }\n        .alert {\n            padding: 1.25rem 1.5rem; border-radius: 0.75rem; margin-bottom: 1.5rem;\n            border-left: 4px solid; display: flex; align-items: start; gap: 1rem;\n            box-shadow: var(--shadow-sm);\n        }\n        .alert-icon { font-size: 1.5rem; flex-shrink: 0; }\n        .alert-info { background: #dbeafe; border-color: #2563eb; color: #1e40af; }\n        .alert-warning { background: #fef3c7; border-color: #f59e0b; color: #92400e; }\n        .alert-success { background: #d1fae5; border-color: #10b981; color: #065f46; }\n        @media print {\n            body { background: white; }\n            .nav-tabs { display: none; }\n            .tab-content { display: block !important; page-break-after: always; }\n            .card { box-shadow: none; border: 1px solid var(--border); page-break-inside: avoid; }\n            .header { box-shadow: none; }\n        }\n    </style>\n</head>\n<body>\n    <div class="container">\n        <div class="header">\n            <div class="header-content">\n                <h1>GDPR Audit Report</h1>\n                <div class="header-subtitle">Leboncoin.fr</div>\n                <div class="header-meta">\n                    <div class="header-meta-item"><span>üìÖ</span><span>October 16, 2025</span></div>\n                    <div class="header-meta-item"><span>üîí</span><span>Confidential</span></div>\n                </div>\n            </div>\n        </div>\n        <div class="content-wrapper">\n            <div class="nav-tabs">\n                <button class="nav-tab active" onclick="switchTab(\'summary\')">üìä Executive Summary</button>\n                <button class="nav-tab" onclick="switchTab(\'violations\')">‚ö†Ô∏è Violations</button>\n                <button class="nav-tab" onclick="switchTab(\'risks\')">üìà Risk Analysis</button>\n                <button class="nav-tab" onclick="switchTab(\'remediation\')">üîß Remediation Plan</button>\n            </div>\n            <div id="tab-summary" class="tab-content active">\n                <div class="stat-grid">\n                    <div class="stat-card">\n                        <div class="stat-card-content">\n                            <div class="stat-label">Risk Level</div>\n                            <div class="stat-value">MEDIUM</div>\n                        </div>\n                        <div class="stat-icon">‚ö†Ô∏è</div>\n                    </div>\n                    <div class="stat-card">\n                        <div class="stat-card-content">\n                            <div class="stat-label">Total Violations</div>\n                            <div class="stat-value">4</div>\n                        </div>\n                        <div class="stat-icon">üö®</div>\n                    </div>\n                    <div class="stat-card">\n                        <div class="stat-card-content">\n                            <div class="stat-label">Estimated Fine</div>\n                            <div class="stat-value">‚Ç¨962K</div>\n                        </div>\n                        <div class="stat-icon">üí∞</div>\n                    </div>\n                    <div class="stat-card">\n                        <div class="stat-card-content">\n                            <div class="stat-label">Investment Required</div>\n                            <div class="stat-value">‚Ç¨176K</div>\n                        </div>\n                        <div class="stat-icon">üíº</div>\n                    </div>\n                </div>\n                <div class="card">\n                    <div class="card-header"><span class="card-header-icon">üìä</span>Scan Overview</div>\n                    <div class="info-grid">\n                        <div class="info-item"><div class="info-label">Target URL</div><div class="info-value">leboncoin.fr</div></div>\n                        <div class="info-item"><div class="info-label">Scan Type</div><div class="info-value">Full Scan</div></div>\n                        <div class="info-item"><div class="info-label">Duration</div><div class="info-value">2 hours</div></div>\n                        <div class="info-item"><div class="info-label">Status</div><div class="info-value">Completed</div></div>\n                    </div>\n                </div>\n            </div>\n            <div id="tab-violations" class="tab-content">\n                <div class="card">\n                    <div class="card-header"><span class="card-header-icon">‚ö†Ô∏è</span>Detected Violations</div>\n                    <div class="violation-card">\n                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">\n                            <h4 style="font-weight: 700; font-size: 1.125rem;">Tracking Without Consent</h4>\n                            <span class="badge badge-critical">CRITICAL</span>\n                        </div>\n                        <p style="color: var(--text-secondary); line-height: 1.6;">Browser fingerprinting via Canvas API detected. Techniques used: Canvas 2D text rendering, Canvas toDataURL() extraction, WebGL parameters extraction.</p>\n                    </div>\n                    <div class="violation-card">\n                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">\n                            <h4 style="font-weight: 700; font-size: 1.125rem;">Privacy Policy Deficient</h4>\n                            <span class="badge badge-critical">CRITICAL</span>\n                        </div>\n                        <p style="color: var(--text-secondary); line-height: 1.6;">No privacy policy link found on the page. GDPR Articles 13-14 require clear information about data processing.</p>\n                    </div>\n                    <div class="violation-card">\n                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">\n                            <h4 style="font-weight: 700; font-size: 1.125rem;">Security Breach</h4>\n                            <span class="badge badge-medium">MEDIUM</span>\n                        </div>\n                        <p style="color: var(--text-secondary); line-height: 1.6;">Found 4 cookies without Secure flag (tracking/authentication cookies).</p>\n                    </div>\n                </div>\n            </div>\n            <div id="tab-risks" class="tab-content">\n                <div class="card">\n                    <div class="card-header"><span class="card-header-icon">üìà</span>Risk Assessment</div>\n                    <div class="alert alert-warning">\n                        <span class="alert-icon">‚ö†Ô∏è</span>\n                        <div><strong>Estimated Fine Range:</strong> ‚Ç¨815K - ‚Ç¨1.35M (Median: ‚Ç¨962K)</div>\n                    </div>\n                    <p style="color: var(--text-secondary); line-height: 1.7; margin-top: 1rem;">Based on analysis of 2,091 similar GDPR cases, the estimated fine range considers violation severity, company size, and aggravating factors.</p>\n                </div>\n            </div>\n            <div id="tab-remediation" class="tab-content">\n                <div class="card">\n                    <div class="card-header"><span class="card-header-icon">üîß</span>Remediation Plan</div>\n                    <div class="alert alert-success">\n                        <span class="alert-icon">‚úÖ</span>\n                        <div><strong>Expected ROI:</strong> 447% | <strong>Timeline:</strong> 5 months | <strong>Investment:</strong> ‚Ç¨176K</div>\n                    </div>\n                    <h4 style="font-weight: 700; margin: 2rem 0 1rem;">Phase 1: Consent & Tracking Compliance</h4>\n                    <p style="color: var(--text-secondary); line-height: 1.7;">Implement CMP (OneTrust/Didomi), audit and remove non-compliant trackers. Duration: 35 days, Cost: ‚Ç¨65K</p>\n                    <h4 style="font-weight: 700; margin: 2rem 0 1rem;">Phase 2: Transparency & Privacy Policy</h4>\n                    <p style="color: var(--text-secondary); line-height: 1.7;">Rewrite privacy policy, develop rights management portal. Duration: 35 days, Cost: ‚Ç¨45K</p>\n                    <h4 style="font-weight: 700; margin: 2rem 0 1rem;">Phase 3: Governance & Continuous Monitoring</h4>\n                    <p style="color: var(--text-secondary); line-height: 1.7;">Deploy monitoring platform, training and certification program. Duration: 70 days, Cost: ‚Ç¨65K</p>\n                </div>\n            </div>\n        </div>\n    </div>\n    <script>\n        function switchTab(tabName) {\n            document.querySelectorAll(\'.tab-content\').forEach(tab => tab.classList.remove(\'active\'));\n            document.querySelectorAll(\'.nav-tab\').forEach(btn => btn.classList.remove(\'active\'));\n            document.getElementById(`tab-${tabName}`).classList.add(\'active\');\n            event.target.classList.add(\'active\');\n        }\n    </script>\n</body>\n</html>'
    )
    RETURNING id INTO demo_scan_id;

    RAISE NOTICE 'Demo scan created with ID: %', demo_scan_id;
    RAISE NOTICE 'You can now view the report at: /reports/%/view', demo_scan_id;
    
END $$;
